#! /usr/bin/env bash

#Sudo Failsafe
if [[ $EUID -ne 0 ]]; then
  echo 'Please run as root (sudo $0)' >&2
  exit 1
fi

#Users
#Variables
#Ubuntu Prctice
#Admins=('perry' 'carlos' 'kan' 'alice' 'josefina')
#Standard=('jaimie' 'adalbern' 'amayas' 'fabienne' 'mariya' 'cornelius' 'harold' 'taran' 'felix' 'angela' 'rais' 'miriam' 'aldo' 'timothy' 'leilani' 'viktor' 'linda' 'jeanne' 'martin' 'josef' 'roger' 'stacy' 'suzy' 'liz')
#Admins=('chowe' 'miles' 'gwen' 'peter')
#Standard=('peni' 'noir' 'ham' 'stan' 'steve' 'miguel' 'jefferson' 'rio' 'may' 'jessica' 'pavitr' 'maryjane')
Admins=(' ')
Standard=(' ')
Allowed_Users=("${Admins[@]}" "${Standard[@]}")
Users=($(cut -d: -f1 /etc/passwd))
#functions
elevate() { usermod -aG sudo "$1"; }
demote()  { gpasswd -d "$1" sudo; }
remove()  { userdel -r "$1"; }
password() { echo "$1:N!w0tC0ug@rS2025" | chpasswd; }
#execute
for user in "${Users[@]}"; do
	if [ "$user" = "$(whoami)" ]; then
		continue
	else
		uid=$(id -u "$user")

		if [[ $uid -lt 1000 ]]; then
		    echo "Skipping password change for system account: $user"
		    continue
		fi

		password $user
	fi
	if [[ " ${Allowed_Users[@]} " =~ " $user " ]]; then
		if [[ " ${Admins[@]} " =~ " $user " ]]; then
			elevate $user
		else
			demote $user
		fi
		sudo chage -M 90 $user
		sudo getent shadow $user
	else
		uid=$(id -u "$user")

		# If UID < 1000, skip deletion (it's a system account)
		if [[ $uid -lt 1000 ]]; then
		    echo "Skipping system account: $user"
		    continue
		fi
		
		# Otherwise safe to remove
		remove $user
	fi
done
#Root & Guest
echo "allow-guest=false" >> /usr/share/lightdm/lightdm.conf.d/50-ubuntu.conf
sed -i '/allow-root=true/d' /etc/lightdm/lightdm.conf
sudo passwd -l root

#UFW
sudo ufw enable && sudo ufw allow ssh

#Secpols
#Password
sed -i 's/^\(FAIL_LOG_ENAB\s*\).*/\1FAIL_LOG_ENAB Yes/' /etc/login.defs
sed -i 's/^\(LOG_OK_LOGINS\s*\).*/\1LOG_OK_LOGINS Yes/' /etc/login.defs
sed -i 's/^\(LOG_UNKFAIL_ENAB\s*\).*/\1LOG_UNKFAIL_ENAB Yes/' /etc/login.defs
sed -i 's/^\(SYSLOG_SU_ENAB\s*\).*/\1SYSLOG_SU_ENAB Yes/' /etc/login.defs
sed -i 's/^\(SYSLOG_SG_ENAB\s*\).*/\1SYSLOG_SG_ENAB Yes/' /etc/login.defs
sed -i 's/^\(PASS_MAX_DAYS\s*\).*/\1PASS_MAX_DAYS 90/' /etc/login.defs
sed -i 's/^\(PASS_MIN_DAYS\s*\).*/\1PASS_MIN_DAYS 15/' /etc/login.defs
sed -i 's/^\(PASS_WARN_AGE\s*\).*/\1PASS_WARN_AGE 7/' /etc/login.defs
if grep -q 'pam_pwquality.so' /etc/pam.d/common-password; then
    sed -i 's/^\(password requisite pam_pwquality.so\s*\).*/\1password requisite pam_pwquality.so retry=3 minlen=12 maxrepeat=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 difok=4 reject_username enforce_for_root/' /etc/pam.d/common-password
else
    echo "Warning: pam_pwquality.so line not found in /etc/pam.d/common-password"
fi
if grep -q 'pam_unix.so' /etc/pam.d/common-password; then
    sed -i 's/^\(pam_unix.so\s*\).*/\1password [success=1 default=ignore] pam_unix.so obscure yescrypt retry=3 minlen=12 maxrepeat=3 remember=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 difok=4 reject_username enforce_for_root/' /etc/pam.d/common-password
else
    echo "Warning: pam_unix.so line not found in /etc/pam.d/common-password"
fi
if grep -q 'nullok' /etc/pam.d/common-auth; then
    sed -i 's/\bnullok\b//g' /etc/pam.d/common-auth
    echo "Removed nullok from /etc/pam.d/common-auth"
else
    echo "No nullok found in /etc/pam.d/common-auth"
fi
#Account Lockout
sudo cat > /usr/share/pam-configs/faillock << EOF
Name: Enforce failed login attempt counter
Default: no
Priority: 0
Auth-Type: Primary
Auth:
	[default=die] pam_faillock.so authfail
	sufficient pam_faillock.so authsuc
EOF
sudo cat > /usr/share/pam-configs/faillock_notify << EOF
Name: Notify on failed login attempts
Default: no
Priority: 1024
Auth-Type: Primary
Auth:
	requisite pam_faillock.so preauth
EOF
pam-auth-update

#IPv4
sed -i 's/^\(net.ipv4.tcp_syncookies=\s*\).*/\1net.ipv4.tcp_syncookies=1/' /etc/sysctl.conf
sed -i 's/^\(net.ipv4.ip_forward=\s*\).*/\1net.ipv4.ip_forward=0/' /etc/sysctl.conf

#IPv6
echo -e "net.ipv6.conf.all.disable_ipv6=1\nnet.ipv6.conf.default.disable_ipv6=1\nnet.ipv6.conf.lo.disable_ipv6=1" >> /etc/sysctl.conf
sysctl -p
sudo sysctl --system

#Files
#Prohibited
find /home -type f \( -iname "*.mp3" -o -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.ogg" \) -delete

#Permissions
sudo chmod 640 /etc/shadow

#Security Tools
sudo apt-get install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

sudo apt-get install apparmor-utils -y
sudo systemctl enable apparmor
sudo systemctl start apparmor

sudo apt-get install clamav -y

#Services
sudo systemctl disable --now nginx || true
#sudo systemctl disable --now vsftpd || true
sudo systemctl disable --now apache2 || true
sudo systemctl disable --now httpd || true
sudo systemctl disable --now mysql || true
sudo systemctl disable --now postgresql || true
sudo systemctl disable --now samba || true
sudo systemctl disable --now postfix || true
sudo systemctl disable --now sendmail || true
sudo systemctl disable --now cups || true
sudo systemctl disable --now avahi-daemon || true
sudo systemctl disable --now rpcbind || true
sudo systemctl disable --now dnsmasq || true
sudo systemctl disable --now bind9 || true
sudo systemctl disable --now bluetooth || true
sudo systemctl disable --now cups-browsed || true
sudo systemctl disable --now ModemManager || true
sudo systemctl disable --now lxcfs lxd snap.lxd.daemon || true
sudo systemctl disable --now nfs-server || true

#SSH
if grep -q '^PermitRootLogin' /etc/ssh/sshd_config; then
    sed -i 's/^\(PermitRootLogin\s*\).*/\1PermitRootLogin no/' /etc/ssh/sshd_config
else
    echo "Warning: PermitRootLogin line not found in /etc/ssh/sshd_config"
    echo 'PermitRootLogin no' >> /etc/ssh/sshd_config
fi
systemctl restart ssh

#Updates
#Auto
apt-get install -y unattended-upgrades

cat << EOF > /etc/apt/apt.conf.d/10periodic
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
EOF

cat << EOF > /etc/apt/apt.conf.d/20auto-upgrades
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
EOF

systemctl enable --now apt-daily.timer
systemctl enable --now apt-daily-upgrade.timer
#Full System
sudo apt-get update && sudo apt-get upgrade -y

#Scan
freshclam
clamscan -r/
